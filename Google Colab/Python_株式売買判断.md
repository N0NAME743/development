##### Memo
üìò Êó•Êú¨Ê†™„Çπ„Ç§„É≥„Ç∞„Éà„É¨„Éº„ÉâÂàÜÊûê„Çπ„ÇØ„É™„Éó„Éà

[‰ªïÁµÑ„Åø]
1.Google„Éâ„É©„Ç§„Éñ„Å´‰øùÂ≠ò„Åó„Å¶„ÅÑ„Çã„Çπ„Éó„É¨„ÉÉ„Éà‰∏ä„Å´„ÄåÈäòÊüÑ„Ç≥„Éº„Éâ„Äç„ÇíÂÖ•Âäõ
2.Google Colab‰∏ä„Åß„ÄÅ„Åì„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°å„Åô„Çã„Å®
    „ÄåÊ†™‰æ°„Éá„Éº„Çø„Äç„ÄÅ„Äå„ÉÜ„ÇØ„Éã„Ç´„É´ÊÉÖÂ†±„Äç„Å™„Å©„ÇíÔºàË°®Ôºã„ÉÅ„É£„Éº„ÉàÔºâÁîªÂÉè„Å®„Åó„Å¶„ÄÅÂá∫Âäõ
[ÂÆüË£ÖÊ©üËÉΩ]
    ver1.00
    „ÉªGoogle„Éâ„É©„Ç§„Éñ„Å®„ÅÆÈÄ£Êê∫
    ver1.01
    „ÉªË°®Á§∫„Éï„É©„Ç∞„Åß„ÄÅÁîªÂÉè„ÅÆ‰øùÂ≠ò„Ç™„É≥„Éª„Ç™„ÉïÊ©üËÉΩ„ÇíÂÆüË£Ö
    ver1.02
    „Éª„Ç≥„Éº„Éâ„ÅÆË¶ãÊ†Ñ„Åà„ÇíÂ∞ë„Åó‰øÆÊ≠£„Åó„Åü„ÄÇ
    „ÉªÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„ÅÆ„Ç≥„Éº„Éâ„ÇíÊú´Â∞æ„Å´ËøΩË®ò
    ver1.10
    „Éª„Çµ„Éù„Éº„Éà„É©„Ç§„É≥„ÄÅ„É¨„Ç∏„Çπ„Çø„É©„Ç§„É≥„Çí„Ç∞„É©„Éï‰∏ä„Å´ËøΩË®ò
    „Éª„Éî„Éù„ÉÉ„Éà„Éù„Ç§„É≥„Éà„Çí„Ç∞„É©„Éï‰∏ä„Å´ËøΩË®ò
    „Éª„ÉÅ„É£„Éº„Éà„ÅÆ„Ç≥„Éº„Éâ„Çí‰øÆÊ≠£„Åó„Åü„ÄÇ

[Êú™ÂÆüË£ÖÊ©üËÉΩ]
    „ÉªÂêÑÊåáÊ®ôÔºà‰æãÔºöÁü≠ÊúüGC, MACD‰∏äÊòá, RSI„Åå‰∏≠Á´ã„Å™„Å©Ôºâ„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅåÈÅéÂéª„Å´„Å©„Çå„Åè„Çâ„ÅÑ„ÅÆÁ¢∫Áéá„ÅßÂãù„Å¶„Åü„ÅãÔºàÔºùÁµÇÂÄ§„Åå‰∏ä„Åå„Å£„Åü„ÅãÔºâ„ÇíÂÖÉ„Å´„ÄÅ
    „Äå‰ªäÂõû„ÅÆ„Ç∑„Ç∞„Éä„É´„ÅÆ‰ø°È†ºÂ∫¶Ôºà„Çπ„Ç≥„Ç¢Ôºâ„Äç„ÇíÂá∫Âäõ„Åô„Çã„ÅÆ„ÅåÁõÆÁöÑ„Åß„Åô„ÄÇ
    „Éª

##### Memo_END

import imgkit
import io
import numpy as np
import matplotlib.pyplot as plt
import mplfinance as mpf
import os
import pandas as pd
import re
import yfinance as yf
from datetime import datetime, timedelta, timezone
from IPython.display import Image, display
from IPython.display import display, HTML
from matplotlib import font_manager
from PIL import Image as PILImage, ImageDraw, ImageFont
from scipy.signal import argrelextrema
from ta.momentum import StochasticOscillator
from ta.trend import MACD, ADXIndicator
from ta.volatility import BollingerBands
from ta import momentum
from tabulate import tabulate

# ‚úÖ Êó•Êú¨Ë™û„Éï„Ç©„É≥„ÉàË®≠ÂÆö
font_path = "/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc"
jp_font = font_manager.FontProperties(fname=font_path)

# ‚úÖ matplotlib „Å´Êó•Êú¨Ë™û„Éï„Ç©„É≥„Éà„ÇíË®≠ÂÆö
plt.rcParams['font.family'] = jp_font.get_name()  # NotoSansCJK „Å´Âàá„ÇäÊõø„Åà

# ‚úÖ PILÁî®„Éï„Ç©„É≥„ÉàË®≠ÂÆöÔºàË°®ÁîªÂÉè„Å´‰Ωø„ÅÜÁî®Ôºâ
from PIL import ImageFont
pil_font = ImageFont.truetype(font_path, 24)

# „Çø„Ç§„É†„Çæ„Éº„É≥„Å®Êó•‰ªò
JST = timezone(timedelta(hours=9))
today_str = datetime.now(JST).strftime("%Y-%m-%d")

# Google Drive„Éû„Ç¶„É≥„Éà
from google.colab import drive
drive.mount('/content/drive')

# ÈäòÊüÑ„É™„Çπ„ÉàÂèñÂæó
sheet_url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZrqf2NhMcD6ebNirrxSV_ibn1FTn2Rj-jrRI27nQcSEAgkqEQfvEZYitYoB1GT65S7qIrgGhMds1i/pub?gid=0&single=true&output=csv"
df_symbols = pd.read_csv(sheet_url)
symbols = df_symbols["Symbol"].dropna().tolist()
print("üîå ÂØæË±°ÈäòÊüÑÔºö", symbols)

# Ë°®Á§∫„Éï„É©„Ç∞
SHOW_VOLUME_MA = 1
SHOW_PRICE_MA = 1
SHOW_MA_DEVIATION = 1
SHOW_TRENDLINE = 1
SHOW_RSI = 1
SHOW_ADX = 1
SHOW_MACD = 1
SHOW_STOCH = 1
SHOW_BB = 1
SHOW_SAVE_CHART = 1

# „ÉÅ„É£„Éº„ÉàÔºã„ÉÜ„Éº„Éñ„É´ÁîªÂÉèÁµ±Âêà‰øùÂ≠òÈñ¢Êï∞
def save_combined_image(chart_path, table_text, output_path):
    font = ImageFont.truetype(font_path, 24)
    lines = table_text.split("\n")
    padding = 10
    max_width = 1600
    image_height = 35 * len(lines)
    table_img = PILImage.new("RGB", (int(max_width), image_height + 2 * padding), "white")
    draw = ImageDraw.Draw(table_img)
    for i, line in enumerate(lines):
        draw.text((padding, i * 35 + padding), line, fill="black", font=font)
    chart_img = PILImage.open(chart_path)
    new_width = max(chart_img.width, table_img.width)
    new_height = chart_img.height + table_img.height
    combined_img = PILImage.new("RGB", (new_width, new_height), "white")
    combined_img.paste(chart_img, (0, 0))
    combined_img.paste(table_img, (0, chart_img.height))
    combined_img.save(output_path)

# ‚úÖ „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ÔºöÊï∞ÂÄ§„ÇíK/M/B„ÅßÁúÅÁï•Ë°®Á§∫
def abbreviate_number(n):
    if n >= 1_000_000_000:
        return f"{n / 1_000_000_000:.2f}B"
    elif n >= 1_000_000:
        return f"{n / 1_000_000:.2f}M"
    elif n >= 1_000:
        return f"{n / 1_000:.2f}K"
    else:
        return str(n)

######### 1.„É´„Éº„Éó-START- #########

for symbol in symbols:
    try:
        info = yf.Ticker(symbol).info
        name = info.get("shortName", "ÂêçÁß∞‰∏çÊòé")
        df = yf.download(symbol, period="15mo", interval="1d", auto_adjust=False)

        if isinstance(df.columns, pd.MultiIndex):
            df.columns = df.columns.get_level_values(0)

        df = df.dropna(subset=["Open", "High", "Low", "Close", "Volume"]).astype(float)
        df.index.name = "Date"

        # „ÉÜ„ÇØ„Éã„Ç´„É´ÊåáÊ®ô
        df["RSI"] = momentum.RSIIndicator(df["Close"], window=14).rsi()
        df["Vol_MA5"] = df["Volume"].rolling(5).mean()
        df["Vol_MA25"] = df["Volume"].rolling(25).mean()
        df["MA5"] = df["Close"].rolling(5).mean()
        df["MA25"] = df["Close"].rolling(25).mean()
        df["MA75"] = df["Close"].rolling(75).mean()
        df["MA200"] = df["Close"].rolling(200).mean()
        if SHOW_MACD:
            macd = MACD(df["Close"])
            df["MACD"] = macd.macd()
            df["MACD_Signal"] = macd.macd_signal()
            df["MACD_Diff"] = macd.macd_diff()
        if SHOW_BB:
            bb = BollingerBands(df["Close"])
            df["BB_High"] = bb.bollinger_hband()
            df["BB_Low"] = bb.bollinger_lband()
            df["BB_MAVG"] = bb.bollinger_mavg()
        if SHOW_ADX:
            adx = ADXIndicator(df["High"], df["Low"], df["Close"])
            df["ADX"] = adx.adx()
        if SHOW_STOCH:
            stoch = StochasticOscillator(df["High"], df["Low"], df["Close"])
            df["STOCH_K"] = stoch.stoch()
            df["STOCH_D"] = stoch.stoch_signal()
        if SHOW_MA_DEVIATION:
            df["MA25_Deviation"] = (df["Close"] - df["MA25"]) / df["MA25"] * 100

        df_filtered = df.dropna().copy()
        df_recent = df_filtered[-60:]
        if df_recent.empty:
            print(f"‚ö†Ô∏è {symbol} „ÅØ„Éá„Éº„Çø‰∏çË∂≥„Åß„Çπ„Ç≠„ÉÉ„Éó")
            continue

######### 2.„ÉÅ„É£„Éº„Éà-START- #########

        add_plots = []
        panel_ratios = [2]  # panel=0: „É°„Ç§„É≥„ÉÅ„É£„Éº„ÉàÔºà„É≠„Éº„ÇΩ„ÇØË∂≥Ôºâ
        panel_id = 1  # Ê¨°„Å´ËøΩÂä†„Åô„Çã panel Áï™Âè∑

        # ‰æãÔºöÂá∫Êù•È´òÁßªÂãïÂπ≥ÂùáÔºà„Éï„É©„Ç∞ONÊôÇ„ÅÆ„ÅøËøΩÂä†Ôºâ
        if SHOW_VOLUME_MA:
            add_plots += [
                mpf.make_addplot(df_recent["Vol_MA5"], panel=panel_id, color="blue"),
                mpf.make_addplot(df_recent["Vol_MA25"], panel=panel_id, color="orange")
            ]
            panel_ratios.append(1)
            panel_id += 1

        # ‰æãÔºöRSIÔºà„Éï„É©„Ç∞ONÊôÇ„ÅÆ„ÅøËøΩÂä†Ôºâ
        if SHOW_RSI:
            add_plots.append(mpf.make_addplot(df_recent["RSI"], panel=panel_id, ylabel="RSI"))
            panel_ratios.append(1)
            panel_id += 1

        # ‰æãÔºöMACDÔºà„Éï„É©„Ç∞ONÊôÇ„ÅÆ„ÅøËøΩÂä†Ôºâ
        if SHOW_MACD:
            add_plots += [
                mpf.make_addplot(df_recent["MACD"], panel=panel_id, color="black", ylabel="MACD"),
                mpf.make_addplot(df_recent["MACD_Signal"], panel=panel_id, color="red"),
                mpf.make_addplot(df_recent["MACD_Diff"], panel=panel_id, color="blue")
            ]
            panel_ratios.append(1)
            panel_id += 1

        # ‚úÖ „Éî„Éú„ÉÉ„Éà„Éù„Ç§„É≥„Éà„ÅÆÊ§úÂá∫Ôºàdf_recent„Éô„Éº„Çπ„Å´Â§âÊõ¥Ôºâ
        price = df_recent["Close"].values
        high_idx = argrelextrema(price, np.greater, order=5)[0]
        low_idx = argrelextrema(price, np.less, order=5)[0]
        # ‚úÖ ÂÖ®‰ΩìÈï∑„Å®Êï¥Âêà„Åô„Çã„Éû„Éº„Ç´„ÉºÈÖçÂàó„Çí‰ΩúÊàê
        high_marker = np.full(len(df_recent), np.nan)
        low_marker = np.full(len(df_recent), np.nan)
        high_marker[high_idx] = price[high_idx]
        low_marker[low_idx] = price[low_idx]
        # ‚úÖ „Éî„Éú„ÉÉ„Éà„Éù„Ç§„É≥„Éà„Çí scatter „Éó„É≠„ÉÉ„Éà„Å®„Åó„Å¶ËøΩÂä†
        add_plots += [
            mpf.make_addplot(high_marker, type='scatter', markersize=100, marker='^', color='red'),
            mpf.make_addplot(low_marker, type='scatter', markersize=100, marker='v', color='blue'),
        ]
        # „É°„Ç§„É≥„ÉÅ„É£„Éº„ÉàËª∏„Å´Ê≥®ÈáàÔºàoptionalÔºâ
        price_ax = axlist[0]
        price_ax.legend(["High Pivot", "Low Pivot"], loc="upper left", fontsize="small")

        fig, axlist = mpf.plot(
            df_recent,
            type="candle",
            style="yahoo",
            volume=False,
            addplot=add_plots,
            panel_ratios=panel_ratios,
            returnfig=True,
            figsize=(12, 6)
        )

        # ‰æãÔºö1600„Éî„ÇØ„Çª„É´ÂπÖ„Å´ÊèÉ„Åà„Åü„ÅÑÂ†¥Âêà
        fig.set_size_inches(1600 / 150, 600 / 150)  # dpi=150„ÅÆÂ†¥Âêà„ÄÅ„Ç§„É≥„ÉÅ = „Éî„ÇØ„Çª„É´ √∑ dpi

        # ‚úÖ Ê≠£„Åó„ÅÑ„Çµ„Éù„Éº„ÉàÔºè„É¨„Ç∏„Çπ„Çø„É≥„Çπ„É©„Ç§„É≥ÊèèÁîª + Ê≥®ÈáàË°®Á§∫Ôºà„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊåáÂÆöÂØæÂøúÁâàÔºâ
        price_ax = axlist[0]  # „É°„Ç§„É≥„ÉÅ„É£„Éº„ÉàËª∏
        # ‰ΩøÁî®„Åô„ÇãÊó•Êï∞
        sr_windows = [20, 60]
        # Ëâ≤Ë®≠ÂÆö
        support_colors = ["#1f77b4", "#17becf"]
        resistance_colors = ["#d62728", "#ff7f0e"]
        # ‚úÖ „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩçÁΩÆ„Éô„Éº„Çπ„ÅßÊ≥®Èáà„ÇíÊèèÁîª„Åô„Çã
        x_pos = len(df_recent) + 1  # „Ç∞„É©„Éï„ÅÆÂè≥Á´Ø„Å°„Çá„ÅÑÂÖà
        for idx, window in enumerate(sr_windows):
            if len(df_recent) >= window:
                support_level = df_recent["Low"].rolling(window=window).min().iloc[-1]
                resistance_level = df_recent["High"].rolling(window=window).max().iloc[-1]
                sup_color = support_colors[idx % len(support_colors)]
                res_color = resistance_colors[idx % len(resistance_colors)]
                # „É©„Ç§„É≥ÊèèÁîª
                price_ax.axhline(support_level, color=sup_color, linestyle='--', linewidth=1.2,
                                alpha=0.8, label=f'Support ({window}d)')
                price_ax.axhline(resistance_level, color=res_color, linestyle='--', linewidth=1.2,
                                alpha=0.8, label=f'Resistance ({window}d)')
                # ‚úÖ Ê≥®ÈáàÔºöXÂ∫ßÊ®ô„ÅØ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅßÊåáÂÆö
                price_ax.text(
                    x_pos, support_level, f'‚Üê Support ({window}d)',
                    verticalalignment='center', fontsize=8, color=sup_color
                )
                price_ax.text(
                    x_pos, resistance_level, f'‚Üê Resistance ({window}d)',
                    verticalalignment='center', fontsize=8, color=res_color
                )
        # Âá°‰æã
        price_ax.legend(loc='upper left', fontsize='small')

        # ‚úÖ Êó•Êú¨Ë™û„Éï„Ç©„É≥„Éà„Çí„Åô„Åπ„Å¶„ÅÆAxes„Å®Text„Å´ÈÅ©Áî®ÔºàsavefigÁõ¥ÂâçÔºâ
        for ax in fig.axes:
            for label in ax.get_xticklabels() + ax.get_yticklabels():
                label.set_fontproperties(jp_font)
            if ax.title:  # „Çø„Ç§„Éà„É´„Åå„ÅÇ„ÇãÂ†¥Âêà
                ax.title.set_fontproperties(jp_font)
            if ax.xaxis.label:  # XËª∏„É©„Éô„É´
                ax.xaxis.label.set_fontproperties(jp_font)
            if ax.yaxis.label:  # YËª∏„É©„Éô„É´
                ax.yaxis.label.set_fontproperties(jp_font)

        # ‚úÖ „Çø„Ç§„Éà„É´„ÇÑÂèñÂæóÊó•„Å™„Å©„ÅÆÊÉÖÂ†±„Çí„Ç∞„É©„Éï‰∏äÈÉ®„Å´ËøΩÂä†
        title = f"{name}Ôºà{symbol}ÔºâÊ†™‰æ°„ÉÅ„É£„Éº„ÉàÔºàÁõ¥Ëøë60Êó•Ôºâ - {today_str}"
        axlist[0].set_title(title, fontproperties=jp_font)

        # ‚úÖ RSI„ÉÅ„É£„Éº„Éà„ÅÆÊèèÂÜôË®≠ÂÆöÔºàrsi_ax_index„ÅåÊ≠£„Åó„ÅèË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂâçÊèêÔºâ
        if rsi_ax_index is not None and rsi_ax_index < len(axlist):
            ax = axlist[rsi_ax_index]
            ax.set_ylim(0, 100)  # ‚Üê Ë°®Á§∫ÁØÑÂõ≤„ÇíÂõ∫ÂÆö
            ax.set_yticks([20, 40, 60, 80])  # ‚Üê ÁõÆÁõõ„Çä„Çí20Âàª„Åø„Å´Âõ∫ÂÆö
            ax.axhline(80, color='red', linestyle='--', linewidth=1)
            ax.axhline(20, color='blue', linestyle='--', linewidth=1)

        # ‚úÖ „Ç∞„É©„ÉïÁîªÂÉè„ÅÆ‰øùÂ≠ò
        chart_path = f"{symbol}_{name}_{today_str}.png"
        for text in fig.texts:
            text.set_fontproperties(jp_font)
        if SHOW_SAVE_CHART:
            fig.savefig(chart_path, dpi=150)
            plt.close(fig)
        if not os.path.exists(chart_path):
            raise FileNotFoundError(f"„ÉÅ„É£„Éº„ÉàÁîªÂÉè„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: {chart_path}")

######### 2.„ÉÅ„É£„Éº„Éà-END- #########
######### 3.„ÉÜ„Éº„Éñ„É´-START- #########

        # ‚úÖ Ë°®„Éá„Éº„Çø„ÅÆ‰ΩúÊàê
        df_recent_week = df_filtered[-7:]
        date_labels = [d.strftime("%-m/%-d") for d in df_recent_week.index]
        divider = lambda name: [f"‚îÄ‚îÄ {name} ‚îÄ‚îÄ"] + ["" for _ in df_recent_week.index]
        table_data = []
        table_data.append(["Ê†™‰æ°ÔºàÁµÇÂÄ§Ôºâ"] + [f"{v:.2f}" for v in df_recent_week["Close"]])
        table_data.append(["Âá∫Êù•È´ò"] + [abbreviate_number(v) for v in df_recent_week["Volume"]])
        table_data.append(divider("ÁßªÂãïÂπ≥ÂùáÁ≥ª"))
        if SHOW_PRICE_MA:
            table_data.append(["5DMA"] + [f"{v:.2f}" for v in df_recent_week["MA5"]])
            table_data.append(["25DMA"] + [f"{v:.2f}" for v in df_recent_week["MA25"]])
            table_data.append(["75DMA"] + [f"{v:.2f}" for v in df_recent_week["MA75"]])
            table_data.append(["200DMA"] + [f"{v:.2f}" for v in df_recent_week["MA200"]])
        if SHOW_MA_DEVIATION:
            table_data.append(["25Êó•‰πñÈõ¢ÁéáÔºà%Ôºâ"] + [f"{v:.2f}" for v in df_recent_week["MA25_Deviation"]])
        table_data.append(divider("„Éà„É¨„É≥„ÉâÁ≥ª"))
        if SHOW_MACD:
            table_data.append(["MACD"] + [f"{v:.2f}" for v in df_recent_week["MACD"]])
        if SHOW_ADX:
            table_data.append(["ADX"] + [f"{v:.2f}" for v in df_recent_week["ADX"]])
        table_data.append(divider("„Ç™„Ç∑„É¨„Éº„Çø„ÉºÁ≥ª"))
        if SHOW_RSI:
            table_data.append(["RSI"] + [f"{v:.2f}" for v in df_recent_week["RSI"]])
        if SHOW_STOCH:
            table_data.append(["„Çπ„Éà„Ç≠„É£„ÇπÔºà%KÔºâ"] + [f"{v:.2f}" for v in df_recent_week["STOCH_K"]])
            table_data.append(["„Çπ„Éà„Ç≠„É£„ÇπÔºà%DÔºâ"] + [f"{v:.2f}" for v in df_recent_week["STOCH_D"]])
        table_data.append(divider("„Éú„É©„ÉÜ„Ç£„É™„ÉÜ„Ç£Á≥ª"))
        if SHOW_BB:
            table_data.append(["BB‰∏äÈôê"] + [f"{v:.2f}" for v in df_recent_week["BB_High"]])
            table_data.append(["BB‰∏≠Â§Æ"] + [f"{v:.2f}" for v in df_recent_week["BB_MAVG"]])
            table_data.append(["BB‰∏ãÈôê"] + [f"{v:.2f}" for v in df_recent_week["BB_Low"]])

        latest = df_recent_week.iloc[-1]
        previous = df_recent_week.iloc[-2]

        # ‚úÖ „Ç≥„É°„É≥„ÉàÂàó‰ΩúÊàê
        comment_map = {}

        # ‚úÖ „Ç≥„É°„É≥„ÉàÂàóÁµ±Âêà
        def emphasize(val):
            if "Ë≤∑„ÅÑ" in val:
                return f"üü¢ {val}"
            elif "Â£≤„Çä" in val:
                return f"üî¥ {val}"
            elif "‰∏≠Á´ã" in val:
                return f"üü° {val}"
            return val

  ######### 2-1.ÊåáÊ®ôÂà§Êñ≠-START- #########

        # Ê†™‰æ°ÔºàÁµÇÂÄ§Ôºâ
        if "Close" in latest and "Close" in previous:
            diff = latest["Close"] - previous["Close"]
            comment_map["Ê†™‰æ°ÔºàÁµÇÂÄ§Ôºâ"] = f"ÁµÇÂÄ§={latest['Close']:.2f}ÔºàÂâçÊó•ÊØî{diff:+.2f}Ôºâ"
        # Âá∫Êù•È´òÔºàÂπ≥ÂùáÔºâ
        if "Volume" in latest and "Volume" in df_recent_week:
            vol_latest = latest["Volume"]
            vol_avg = df_recent_week["Volume"].mean()
            diff = vol_latest - vol_avg
            pct = round((diff / vol_avg) * 100, 1)
            comment_map["Âá∫Êù•È´ò"] = f"7Êó•Âπ≥Âùá={vol_avg:,.0f}ÔºàÂ∑ÆÂàÜ={diff:+,.0f} / {pct:+.1f}%Ôºâ"
        # ‚úÖ ÁßªÂãïÂπ≥ÂùáÁ∑ö-„ÇØ„É≠„ÇπÂà§ÂÆöÔºàÁü≠ÊúüÔºö5DMA vs 25DMAÔºâ
        if latest["MA5"] > latest["MA25"] and previous["MA5"] <= previous["MA25"]:
            gap = (latest["MA5"] - latest["MA25"]) / latest["MA25"] * 100
            if gap > 2:
                strength = "Âº∑"
            elif gap > 1:
                strength = "‰∏≠"
            else:
                strength = "Âº±"
            comment_map["5DMA"] = f"Ë≤∑„ÅÑÔΩúÁü≠ÊúüÔºßÔº£Ôºà{gap:.2f}%‰πñÈõ¢ / ‰ø°È†ºÂ∫¶{strength}Ôºâ"
        elif latest["MA5"] < latest["MA25"] and previous["MA5"] >= previous["MA25"]:
            gap = (latest["MA25"] - latest["MA5"]) / latest["MA25"] * 100
            if gap > 2:
                strength = "Âº∑"
            elif gap > 1:
                strength = "‰∏≠"
            else:
                strength = "Âº±"
            comment_map["5DMA"] = f"Â£≤„ÇäÔΩúÁü≠ÊúüÔº§Ôº£Ôºà{gap:.2f}%‰πñÈõ¢ / ‰ø°È†ºÂ∫¶{strength}Ôºâ"
        else:
            gap = abs(latest["MA5"] - latest["MA25"]) / latest["MA25"] * 100
            comment_map["5DMA"] = f"‰∏≠Á´ãÔΩúÊòéÁ¢∫„Å™„Ç∑„Ç∞„Éä„É´„Å™„ÅóÔºà{gap:.2f}%Â∑ÆÔºâ"

        # ‚úÖ ÁßªÂãïÂπ≥ÂùáÁ∑ö-„ÇØ„É≠„ÇπÂà§ÂÆöÔºà‰∏≠ÊúüÔºö25DMA vs 75DMAÔºâ
        if latest["MA25"] > latest["MA75"] and previous["MA25"] <= previous["MA75"]:
            gap = (latest["MA25"] - latest["MA75"]) / latest["MA75"] * 100
            if gap > 2.5:
                strength = "Âº∑"
            elif gap > 1.0:
                strength = "‰∏≠"
            else:
                strength = "Âº±"
            comment_map["25DMA"] = f"Ë≤∑„ÅÑÔΩú‰∏≠ÊúüÔºßÔº£Ôºà{gap:.2f}%‰πñÈõ¢ / ‰ø°È†ºÂ∫¶{strength}Ôºâ"
        elif latest["MA25"] < latest["MA75"] and previous["MA25"] >= previous["MA75"]:
            gap = (latest["MA75"] - latest["MA25"]) / latest["MA75"] * 100
            if gap > 2.5:
                strength = "Âº∑"
            elif gap > 1.0:
                strength = "‰∏≠"
            else:
                strength = "Âº±"
            comment_map["25DMA"] = f"Â£≤„ÇäÔΩú‰∏≠ÊúüÔº§Ôº£Ôºà{gap:.2f}%‰πñÈõ¢ / ‰ø°È†ºÂ∫¶{strength}Ôºâ"
        else:
            gap = abs(latest["MA25"] - latest["MA75"]) / latest["MA75"] * 100
            comment_map["25DMA"] = f"‰∏≠Á´ãÔΩúÊòéÁ¢∫„Å™„Ç∑„Ç∞„Éä„É´„Å™„ÅóÔºà{gap:.2f}%Â∑ÆÔºâ"

        # ‚úÖ Ë∂Ö„Ç¥„Éº„É´„Éá„É≥„ÇØ„É≠„ÇπÔºè„Éá„ÉÉ„Éâ„ÇØ„É≠„Çπ
        if (
            latest["MA5"] > latest["MA25"] > latest["MA75"] and
            (previous["MA5"] <= previous["MA25"] or previous["MA5"] <= previous["MA75"])
        ):
            gap = (latest["MA5"] - latest["MA75"]) / latest["MA75"] * 100
            if gap > 2.5:
                strength = "Âº∑"
            elif gap > 1.0:
                strength = "‰∏≠"
            else:
                strength = "Âº±"
            comment_map["Ë∂ÖGC"] = f"Ë≤∑„ÅÑÔΩúË∂ÖÔºßÔº£Ôºà5Êó•‚Üí25Êó•‚Üí75Êó• / {gap:.2f}%‰πñÈõ¢ / ‰ø°È†ºÂ∫¶{strength}Ôºâ"
        elif (
            latest["MA5"] < latest["MA25"] < latest["MA75"] and
            (previous["MA5"] >= previous["MA25"] or previous["MA5"] >= previous["MA75"])
        ):
            gap = (latest["MA75"] - latest["MA5"]) / latest["MA75"] * 100
            if gap > 2.5:
                strength = "Âº∑"
            elif gap > 1.0:
                strength = "‰∏≠"
            else:
                strength = "Âº±"
            comment_map["Ë∂ÖDC"] = f"Â£≤„ÇäÔΩúË∂ÖÔº§Ôº£Ôºà5Êó•‚Üí25Êó•‚Üí75Êó• / {gap:.2f}%‰πñÈõ¢ / ‰ø°È†ºÂ∫¶{strength}Ôºâ"
        else:
            order = [latest["MA5"], latest["MA25"], latest["MA75"]]
            if order == sorted(order, reverse=True):
                trend_desc = "‰∏ãÈôçÈ†ÜÂ∫èÔºà5Êó•Ôºú25Êó•Ôºú75Êó•Ôºâ"
            elif order == sorted(order):
                trend_desc = "‰∏äÊòáÈ†ÜÂ∫èÔºà5Êó•Ôºû25Êó•Ôºû75Êó•Ôºâ"
            else:
                trend_desc = "È†ÜÂ∫è„Éê„É©„Éê„É©"
            gap = abs(latest["MA5"] - latest["MA75"]) / latest["MA75"] * 100
            comment_map["Ë∂ÖGC/DC"] = f"‰∏≠Á´ãÔΩúÊòéÁ¢∫„Å™„Ç∑„Ç∞„Éä„É´„Å™„ÅóÔºà{trend_desc} / 5Êó•-75Êó•Â∑ÆÔºö{gap:.2f}ÔºÖÔºâ"

        # ‚úÖ 25Êó•ÁßªÂãïÂπ≥ÂùáÁ∑ö„Åã„Çâ„ÅÆ‰πñÈõ¢
        if "MA25_Deviation" in latest:
            dev = latest["MA25_Deviation"]
            if dev > 5:
                comment_map["25Êó•‰πñÈõ¢ÁéáÔºà%Ôºâ"] = f"Â£≤„ÇäÔΩúÂπ≥Âùá„Çà„ÇäÂ§ß„Åç„Åè‰∏äÊåØ„ÇåÔºàÈÅéÁÜ±ÊÑü„ÅÇ„ÇäÔºâ"
            elif dev < -5:
                comment_map["25Êó•‰πñÈõ¢ÁéáÔºà%Ôºâ"] = f"Ë≤∑„ÅÑÔΩúÂπ≥Âùá„Çà„ÇäÂ§ß„Åç„Åè‰∏ãÊåØ„ÇåÔºàÂâ≤ÂÆâÊÑü„ÅÇ„ÇäÔºâ"
            else:
                comment_map["25Êó•‰πñÈõ¢ÁéáÔºà%Ôºâ"] = f"‰∏≠Á´ãÔΩúÂπ≥Âùá‰ªòËøë„ÅßÂÆâÂÆö"

        # ‚úÖ MACD
        if "MACD_Diff" in latest and "MACD_Diff" in previous:
            val, prev_val = latest["MACD_Diff"], previous["MACD_Diff"]
            diff = val - prev_val
            if val > 0:
                if diff > 0:
                    signal = "Ë≤∑„ÅÑÔΩúMACD‰∏äÊòá‰∏≠ÔºàÂã¢„ÅÑÂº∑Ôºâ"
                else:
                    signal = "Ë≤∑„ÅÑÔΩúMACD„Éó„É©„ÇπÂúè„Å†„ÅåÊ∏õÈÄü‰∏≠ÔºàÊÖéÈáç„Å´Ôºâ"
            else:
                if diff < 0:
                    signal = "Â£≤„ÇäÔΩúMACD‰∏ãÈôç‰∏≠ÔºàÂã¢„ÅÑÂº∑Ôºâ"
                else:
                    signal = "Â£≤„ÇäÔΩúMACD„Éû„Ç§„Éä„ÇπÂúè„Å†„ÅåÊ∏õÈÄü‰∏≠ÔºàÊßòÂ≠êË¶ãÔºâ"
            comment_map["MACD"] = f"{signal}"

        # ‚úÖ ADX
        if "ADX" in latest:
            val = latest["ADX"]
            if val < 20:
                comment_map["ADX"] = f"‰∏≠Á´ãÔΩúÊñπÂêëÊÑü„Å™„ÅóÔºàÊßòÂ≠êË¶ãÔºâ"
            elif val < 25:
                comment_map["ADX"] = f"üü° Ëª¢ÊèõÔΩú„Éà„É¨„É≥„ÉâÁô∫Áîü„ÅÆÂÖÜ„ÅóÔºàÊ≥®ÁõÆÔºâ"
            elif val < 40:
                comment_map["ADX"] = f"üü° ËøΩÈöèÔΩú„Éà„É¨„É≥„ÉâÁô∫Áîü‰∏≠ÔºàÊµÅ„Çå„Å´‰πó„ÇãÂ†¥Èù¢Ôºâ"
            else:
                comment_map["ADX"] = f"üü° ÈÅéÁÜ±ÔΩú„Éà„É¨„É≥„ÉâÈÅéÁÜ±ÔºàÂèçËª¢„Å´Ê≥®ÊÑèÔºâ"

        # ‚úÖ RSI
        if "RSI" in latest and "RSI" in previous:
            val, prev_val = latest["RSI"], previous["RSI"]
            diff = val - prev_val
            trend = "‰∏äÊòá‰∏≠" if diff > 0 else "‰Ωé‰∏ã‰∏≠"

            if val > 80:
                if val >= 82:
                    strength = "Âº∑"
                elif val >= 81:
                    strength = "‰∏≠"
                else:
                    strength = "Âº±"
                comment_map["RSI"] = f"Â£≤„ÇäÔΩúË≤∑„Çè„Çå„Åô„ÅéÔºà{trend} / ÈÅéÁÜ±Â∫¶Ôºö{strength}Ôºâ"
            elif val < 20:
                if val <= 18:
                    strength = "Âº∑"
                elif val <= 19:
                    strength = "‰∏≠"
                else:
                    strength = "Âº±"
                comment_map["RSI"] = f"Ë≤∑„ÅÑÔΩúÂ£≤„Çâ„Çå„Åô„ÅéÔºà{trend} / Ââ≤ÂÆâÂ∫¶Ôºö{strength}Ôºâ"
            else:
                comment_map["RSI"] = f"‰∏≠Á´ãÔΩúÊòéÁ¢∫„Å™„Ç∑„Ç∞„Éä„É´„Å™„ÅóÔºà{trend} / ÂâçÊó•ÊØî{diff:+.2f}Ôºâ"

        # ‚úÖ „Çπ„Éà„Ç≠„É£„Çπ„ÉÜ„Ç£„ÇØ„Çπ
        if "STOCH_K" in latest and "STOCH_D" in latest:
            k, d = latest["STOCH_K"], latest["STOCH_D"]
            if k < 20 and k > d:
                comment_map["„Çπ„Éà„Ç≠„É£„ÇπÔºà%KÔºâ"] = f"Ë≤∑„ÅÑÔΩú%K={k:.2f} > %D={d:.2f}"
            elif k > 80 and k < d:
                comment_map["„Çπ„Éà„Ç≠„É£„ÇπÔºà%KÔºâ"] = f"Â£≤„ÇäÔΩú%K={k:.2f} < %D={d:.2f}"
            else:
                trend = "Ê®™„Å∞„ÅÑ"
                comment_map["„Çπ„Éà„Ç≠„É£„ÇπÔºà%KÔºâ"] = f"‰∏≠Á´ãÔΩú%K={k:.2f}Ôºà{trend}‰∏≠Ôºâ"

        if "STOCH_D" in latest and "STOCH_D" in previous:
            d_val, prev_d_val = latest["STOCH_D"], previous["STOCH_D"]
            diff = d_val - prev_d_val
            trend = "‰∏äÊòá" if diff > 0 else "‰Ωé‰∏ã"
            if d_val > 80:
                comment_map["„Çπ„Éà„Ç≠„É£„ÇπÔºà%DÔºâ"] = f"Â£≤„ÇäÔΩú%D={d_val:.2f}Ôºà{trend}‰∏≠Ôºâ"
            elif d_val < 20:
                comment_map["„Çπ„Éà„Ç≠„É£„ÇπÔºà%DÔºâ"] = f"Ë≤∑„ÅÑÔΩú%D={d_val:.2f}Ôºà{trend}‰∏≠Ôºâ"
            else:
                comment_map["„Çπ„Éà„Ç≠„É£„ÇπÔºà%DÔºâ"] = f"‰∏≠Á´ãÔΩú%D={d_val:.2f}Ôºà{trend}‰∏≠Ôºâ"

        # ‚úÖ „Éú„É™„É≥„Ç∏„É£„Éº„Éê„É≥„Éâ
        if all(k in latest for k in ["Close", "BB_High", "BB_Low", "BB_MAVG"]):
            close = latest["Close"]
            bb_high = latest["BB_High"]
            bb_low = latest["BB_Low"]
            bb_mid = latest["BB_MAVG"]
            band_width = bb_high - bb_low
            diff_from_mid = close - bb_mid

            if close > bb_high:
                comment_map["BB‰∏äÈôê"] = f"Â£≤„ÇäÔΩúÊ†™‰æ°ÔºàÁµÇÂÄ§Ôºâ={close:.2f} > BB‰∏äÈôê{bb_high:.2f}ÔºàË≤∑„Çè„Çå„Åô„ÅéÔºâ"
            elif close < bb_low:
                comment_map["BB‰∏ãÈôê"] = f"Ë≤∑„ÅÑÔΩúÊ†™‰æ°ÔºàÁµÇÂÄ§Ôºâ={close:.2f} < BB‰∏ãÈôê{bb_low:.2f}ÔºàÂ£≤„Çâ„Çå„Åô„ÅéÔºâ"
            else:
                deviation = (close - (bb_high + bb_low) / 2) / band_width * 100
                comment_map["BB‰∏≠Â§Æ"] = f"‰∏≠Á´ãÔΩú‰πñÈõ¢={diff_from_mid:+.2f}ÂÜÜÔºàÁµÇÂÄ§={close:.2f} Ôºâ"

  ######### ÊåáÊ®ôÂà§Êñ≠-END- #########

        # ‚úÖ „ÉÜ„Éº„Éñ„É´_Ë°®Á§∫Âá¶ÁêÜ
        styled_table = []
        for row in table_data:
            label = row[0]
            comment = comment_map.get(label, "")
            styled_row = row + [emphasize(comment)]
            styled_table.append(styled_row)

        # ‚úÖ „ÉÜ„Éº„Éñ„É´_Ë¶ãÊ†Ñ„ÅàË®≠ÂÆö
        from IPython.display import HTML

        df_table = pd.DataFrame(styled_table, columns=["ÊåáÊ®ô"] + date_labels + ["„Ç≥„É°„É≥„Éà"])

        styler = df_table.style.set_properties(**{'text-align': 'right'})
        styler = styler.set_properties(subset=["„Ç≥„É°„É≥„Éà"], **{'text-align': 'left'})
        styler = styler.set_table_styles([
            {"selector": "table", "props": [("border-collapse", "collapse"), ("border", "0px solid #ccc")]},
            {"selector": "th", "props": [("border", "1px solid #ccc"), ("background-color", "#f0f0f0"), ("text-align", "center")]},
            {"selector": "td", "props": [("border", "1px solid #ccc"), ("padding", "4px")]}
        ])

        # ‚úÖ Á∑èÂêà„Ç∑„Ç∞„Éä„É´Ë©ï‰æ°ÔºàÂÖà„Å´Ë®àÁÆó„Åó„Å¶„Åã„ÇâË°®Á§∫Ôºâ
        buy_signals = sum("Ë≤∑„ÅÑ" in c for c in comment_map.values())
        sell_signals = sum("Â£≤„Çä" in c for c in comment_map.values())
        if buy_signals > sell_signals:
            overall = "üîº Ë≤∑„ÅÑÂÑ™Âã¢"
        elif sell_signals > buy_signals:
            overall = "üîΩ Â£≤„ÇäÂÑ™Âã¢"
        else:
            overall = "‚è∏ ‰∏≠Á´ã„ÉªÊßòÂ≠êË¶ã"

        # ‚úÖ collapse„ÇíÂº∑Âà∂ÈÅ©Áî®„Åô„ÇãÔºÅ
        styler = styler.set_table_attributes('style="border-collapse: collapse; border: 1px solid #ccc;"')

        # ‚úÖ full_html „ÇíÂÆöÁæ©Ôºà‚Üê„Åì„Çå„ÇÇÂøÖÈ†àÔºÅÔºâ
        full_html = f"""
        <h4>{name}Ôºà{symbol}ÔºâÔΩúÂèñÂæóÊó•: {today_str}</h4>
        <p><b>‚úÖ Á∑èÂêà„Ç∑„Ç∞„Éä„É´Ôºö</b> {overall}ÔºàË≤∑„ÅÑ: {buy_signals}ÔΩúÂ£≤„Çä: {sell_signals}Ôºâ</p>
        {styler.to_html(escape=False)}
        """

        # ‚úÖ „ÉÜ„Éº„Éñ„É´_Ë°®Á§∫Ôºàescape=False „ÅßÁµµÊñáÂ≠ó„ÇÇË°®Á§∫Ôºâ
        from IPython.display import HTML

        #display(HTML(styler.to_html(escape=False)))
        display(HTML(full_html))
        display(Image(chart_path))
        #display(HTML(f'<img src="{chart_path}" style="width: 80%;">'))

        #comment_map = get_signal_comment(latest, previous)
        #score = float(comment_map["‚úÖ Á∑èÂêàË©ï‰æ°"].split("„Çπ„Ç≥„Ç¢:")[-1])
        #interpret_comment_map(comment_map, score)

        # „Éï„Ç°„Ç§„É´‰øùÂ≠òË®≠ÂÆö
        from PIL import Image as PILImage

        def save_combined_chart_and_table(chart_path, html_table, output_dir, symbol, name, today_str,
                                          table_image_path="table_temp.jpg", save_pdf=False):
            """
            Ë°®ÔºàHTMLÔºâ„Å®„ÉÅ„É£„Éº„ÉàÁîªÂÉè„ÇíÁµêÂêà„Åó„ÄÅJPG„Å®ÂøÖË¶Å„Å´Âøú„Åò„Å¶PDF„Å®„Åó„Å¶‰øùÂ≠ò„ÄÇ
            """
            # ‚úÖ HTML‚ÜíÁîªÂÉèÂåñÔºà„ÉÜ„Éº„Éñ„É´Ôºâ
            with open("temp_table.html", "w", encoding="utf-8") as f:
                f.write(html_table)

            config = imgkit.config(wkhtmltoimage='/usr/bin/wkhtmltoimage')
            options = {
                'format': 'jpg',
                'encoding': "UTF-8",
                'custom-header': [('Accept-Encoding', 'gzip')],
                'quality': '85',
                'zoom': 2,
                'crop-w': 1600
            }
            imgkit.from_file("temp_table.html", table_image_path, config=config, options=options)

            # ‚úÖ ÁîªÂÉèË™≠„ÅøËæº„Åø„ÉªÁµêÂêà
            chart_img = PILImage.open(chart_path)
            table_img = PILImage.open(table_image_path)

            def resize_to_width(img, target_width):
                w, h = img.size
                if w == target_width:
                    return img
                new_h = int(h * (target_width / w))
                return img.resize((target_width, new_h), PILImage.LANCZOS)

            max_width = max(chart_img.width, table_img.width)
            chart_img = resize_to_width(chart_img, max_width)
            table_img = resize_to_width(table_img, max_width)

            combined_height = chart_img.height + table_img.height
            combined_img = PILImage.new("RGB", (max_width, combined_height), "white")
            combined_img.paste(table_img, (0, 0))
            combined_img.paste(chart_img, (0, table_img.height))

            # ‚úÖ ‰øùÂ≠òÂÖà„Éï„Ç©„É´„ÉÄ„Å®„Éï„Ç°„Ç§„É´Âêç
            save_folder = os.path.join(output_dir, f"{symbol}_{name}")
            os.makedirs(save_folder, exist_ok=True)
            base_filename = f"{symbol}_{name}_{today_str}"
            jpg_path = os.path.join(save_folder, base_filename + ".jpg")

            # ‚úÖ JPG‰øùÂ≠ò
            combined_img.save(jpg_path, optimize=True, quality=85)
            print(f"‚úÖ JPG„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºö{jpg_path}")

            # ‚úÖ PDF‰øùÂ≠òÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            if save_pdf:
                pdf_path = os.path.join(save_folder, base_filename + ".pdf")
                rgb_img = combined_img.convert("RGB")  # PDF„ÅØRGBÂøÖË¶Å
                rgb_img.save(pdf_path, "PDF", resolution=100.0)
                print(f"üìÑ PDF„Å®„Åó„Å¶„ÇÇ‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºö{pdf_path}")

        if SHOW_SAVE_CHART:
          output_dir = "/content/drive/MyDrive/ColabNotebooks/ÈäòÊüÑÂàÜÊûê"
          # PDF„Åå‰∏çË¶Å„Å™„Çâ„Äåsave_pdf=False„Äç„Å´„Åô„Çã
          save_combined_chart_and_table(chart_path, full_html, output_dir, symbol, name, today_str, save_pdf=True)

######### 3.„ÉÜ„Éº„Éñ„É´-END- #########

    except Exception as e:
        print(f"‚ùå „Ç®„É©„Éº: {symbol} - {e}")

######### „É´„Éº„Éó-END- #########
