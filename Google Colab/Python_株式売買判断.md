##### Memo
ğŸ“˜ æ—¥æœ¬æ ªã‚¹ã‚¤ãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒ‰åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆ

[ä»•çµ„ã¿]
1.Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ä¿å­˜ã—ã¦ã„ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒˆä¸Šã«ã€ŒéŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã€ã‚’å…¥åŠ›
2.Google Colabä¸Šã§ã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨
    ã€Œæ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã€ã€ã€Œãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æƒ…å ±ã€ãªã©ã‚’ï¼ˆè¡¨ï¼‹ãƒãƒ£ãƒ¼ãƒˆï¼‰ç”»åƒã¨ã—ã¦ã€å‡ºåŠ›
[å®Ÿè£…æ©Ÿèƒ½]
    ver1.00
    ãƒ»Googleãƒ‰ãƒ©ã‚¤ãƒ–ã¨ã®é€£æº
    ver1.01
    ãƒ»è¡¨ç¤ºãƒ•ãƒ©ã‚°ã§ã€ç”»åƒã®ä¿å­˜ã‚ªãƒ³ãƒ»ã‚ªãƒ•æ©Ÿèƒ½ã‚’å®Ÿè£…
    ver1.02
    ãƒ»ã‚³ãƒ¼ãƒ‰ã®è¦‹æ „ãˆã‚’å°‘ã—ä¿®æ­£ã—ãŸã€‚
    ãƒ»å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã‚’æœ«å°¾ã«è¿½è¨˜
    ver1.10
    ãƒ»ã‚µãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã€ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ©ã‚¤ãƒ³ã‚’ã‚°ãƒ©ãƒ•ä¸Šã«è¿½è¨˜
    ãƒ»ãƒ”ãƒãƒƒãƒˆãƒã‚¤ãƒ³ãƒˆã‚’ã‚°ãƒ©ãƒ•ä¸Šã«è¿½è¨˜
    ãƒ»ãƒãƒ£ãƒ¼ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ãŸã€‚
    ver1.11
    ãƒ»ãƒãƒ£ãƒ¼ãƒˆã‚°ãƒ©ãƒ•ã®å†…å®¹ã‚’å¤§å¹…ã«ä¿®æ­£ã—ãŸã€‚
    ãƒ»ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºã®ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ãŸã€‚
    ãƒ»ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰ã®è¡¨ç¤ºã‚’è¿½åŠ ã—ãŸâ¡éè¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    ver1.20ï½œã‚³ãƒ¼ãƒ‰ä¿®æ­£é€”ä¸­
    ãƒ»ã‚³ãƒ¼ãƒ‰ã®ä¸­èº«ã‚’æ•´ãˆã¦ã€ä¸è¦ãªã‚³ãƒ¼ãƒ‰ç­‰ã‚’å‰Šé™¤ã—ãŸã€‚
    ãƒ»æ—§ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨è¨˜ï¼ˆStylerï¼‰ã‚’å‰Šé™¤ã—ã€HTMLãƒ†ãƒ¼ãƒ–ãƒ«ã§ç”»åƒã®ä¿å­˜å‡¦ç†ã‚’ä½œã£ãŸã€‚
    ver1.21
    ãƒ»ã‚³ãƒ¼ãƒ‰ã®é †åºã‚’æ•´ç†ã—ãŸã€‚
    ãƒ»ãƒãƒ£ãƒ¼ãƒˆã®è¡¨ç¤ºã‚’å¾®èª¿æ•´ï¼‹ã‚¿ã‚¤ãƒˆãƒ«ï¼ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ãŸã€‚
    ver.1.22
    ãƒ»ç·åˆè©•ä¾¡ã®éƒ¨åˆ†ã‚’æœ«å°¾ã‹ã‚‰ã€Œãƒãƒ£ãƒ¼ãƒˆã€ã€ã€Œè¡¨ã€ã®çœŸã‚“ä¸­ã«ç§»å‹•ã•ã›ãŸã€‚
    ãƒ»ã‚¹ã‚³ã‚¢ã®ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ã§ç®—å‡ºã™ã‚‹ã‚ˆã†ã«ã—ãŸï¼ˆâ€»è¦èª¿æ•´ï¼‰
[æœªå®Ÿè£…æ©Ÿèƒ½]
    ãƒ»å„æŒ‡æ¨™ï¼ˆä¾‹ï¼šçŸ­æœŸGC, MACDä¸Šæ˜‡, RSIãŒä¸­ç«‹ãªã©ï¼‰ã®çµ„ã¿åˆã‚ã›ãŒéå»ã«ã©ã‚Œãã‚‰ã„ã®ç¢ºç‡ã§å‹ã¦ãŸã‹ï¼ˆï¼çµ‚å€¤ãŒä¸ŠãŒã£ãŸã‹ï¼‰ã‚’å…ƒã«ã€
    ã€Œä»Šå›ã®ã‚·ã‚°ãƒŠãƒ«ã®ä¿¡é ¼åº¦ï¼ˆã‚¹ã‚³ã‚¢ï¼‰ã€ã‚’å‡ºåŠ›ã™ã‚‹ã®ãŒç›®çš„ã§ã™ã€‚
    ãƒ»
##### Memo_END

######### 0.Condigï¼ˆè¨­å®šï¼‰

import imgkit
import io
import numpy as np
import matplotlib.pyplot as plt
import mplfinance as mpf
import os
import pandas as pd
import re
import yfinance as yf
from datetime import datetime, timedelta, timezone
from IPython.display import Image, display
from IPython.display import display, HTML
from matplotlib import font_manager
from PIL import Image as PILImage, ImageDraw, ImageFont
from scipy.signal import argrelextrema
from ta.momentum import StochasticOscillator
from ta.trend import ADXIndicator, CCIIndicator, MACD, IchimokuIndicator
from ta.volatility import BollingerBands
from ta import momentum
from tabulate import tabulate

## æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
font_path = "/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc"
jp_font = font_manager.FontProperties(fname=font_path)
plt.rcParams['font.family'] = jp_font.get_name()  # NotoSansCJK ã«åˆ‡ã‚Šæ›¿ãˆ
pil_font = ImageFont.truetype(font_path, 24)

## ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¨æ—¥ä»˜
JST = timezone(timedelta(hours=9))
today_str = datetime.now(JST).strftime("%Y-%m-%d")

## Google Driveãƒã‚¦ãƒ³ãƒˆ
from google.colab import drive
drive.mount('/content/drive')

## éŠ˜æŸ„ãƒªã‚¹ãƒˆå–å¾—
sheet_url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZrqf2NhMcD6ebNirrxSV_ibn1FTn2Rj-jrRI27nQcSEAgkqEQfvEZYitYoB1GT65S7qIrgGhMds1i/pub?gid=0&single=true&output=csv"
df_symbols = pd.read_csv(sheet_url)
symbols = df_symbols["Symbol"].dropna().tolist()
print("ğŸ”Œ å¯¾è±¡éŠ˜æŸ„ï¼š", symbols)

## è¡¨ç¤ºãƒ•ãƒ©ã‚°
SHOW_VOLUME_MA = 1
SHOW_PRICE_MA = 1
SHOW_MA_DEVIATION = 1
SHOW_TRENDLINE = 1
SHOW_RSI = 1
SHOW_ADX = 1
SHOW_MACD = 1
SHOW_STOCH = 1
SHOW_BB = 1
SHOW_SAVE_CHART = 1

## å®šç¾©ãƒ»é–¢æ•°
# 1. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ç³»é–¢æ•°ï¼šæ•°å€¤ã‚’K/M/Bã§çœç•¥è¡¨ç¤º
def abbreviate_number(n):
    if n >= 1_000_000_000:
        return f"{n / 1_000_000_000:.2f}B"
    elif n >= 1_000_000:
        return f"{n / 1_000_000:.2f}M"
    elif n >= 1_000:
        return f"{n / 1_000:.2f}K"
    else:
        return str(n)
# 2. ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆé–¢æ•°

def generate_summary_comment(comment_map, score):
    buy_comments = []
    sell_comments = []

    for key, comment in comment_map.items():
        # æ¡ä»¶åˆ†å²ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆåˆ†é¡
        ...

    if score >= 5:
        summary = "..."
    elif score >= 2:
        summary = "..."
    elif score <= -5:
        summary = "..."
    elif score <= -2:
        summary = "..."
    else:
        summary = "..."

    html = "<div>...</div>"
    return html


def generate_summary_comment(comment_map, score):
    buy_comments = []
    sell_comments = []

    # è²·ã„ãƒ»å£²ã‚Šã‚³ãƒ¡ãƒ³ãƒˆã‚’æ•´ç†
    for key, comment in comment_map.items():
        if "è²·ã„" in comment:
            buy_comments.append(f"<li>{key}ï¼š{comment}</li>")
        elif "å£²ã‚Š" in comment:
            sell_comments.append(f"<li>{key}ï¼š{comment}</li>")

    # ç·è©•ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæˆ¦ç•¥ææ¡ˆè¾¼ã¿ï¼‰
    if score >= 5:
        summary = ("å¼·ã„è²·ã„ã‚·ã‚°ãƒŠãƒ«ãŒè¤‡æ•°ç¢ºèªã•ã‚Œã€ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ãŒæ˜ç¢ºã§ã™ã€‚"
                  "çŸ­æœŸã®æŠ¼ã—ç›®ã‚’ç‹™ã£ãŸè²·ã„ãŒæœ‰åŠ¹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚")
    elif score >= 2:
        summary = ("è²·ã„ã‚·ã‚°ãƒŠãƒ«ãŒã‚„ã‚„å„ªå‹¢ã§ã€åè»¢ã®å…†ã—ãŒè¦‹ãˆå§‹ã‚ã¦ã„ã¾ã™ã€‚"
                  "ãŸã ã—ã€å‡ºæ¥é«˜ã‚„éç†±æ„Ÿã«æ³¨æ„ã—ãªãŒã‚‰ã€æ…é‡ãªã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚")
    elif score <= -5:
        summary = ("è¤‡æ•°ã®å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ã«ã‚ˆã‚Šã€æ˜ç¢ºãªä¸‹è½ãƒˆãƒ¬ãƒ³ãƒ‰ãŒå½¢æˆã•ã‚Œã¦ã„ã¾ã™ã€‚"
                  "ã“ã“ã§ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã¯é¿ã‘ã€åç™ºã®å…†å€™ãŒè¦‹ãˆã‚‹ã¾ã§æ§˜å­ã‚’è¦‹ã‚‹æˆ¦ç•¥ãŒè³¢æ˜ã§ã™ã€‚")
    elif score <= -2:
        summary = ("å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ãŒã‚„ã‚„å„ªå‹¢ã§ã€ä¸‹æ–¹å‘ã¸ã®ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚"
                  "ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’è»½ãã™ã‚‹ã‹ã€æ–°è¦ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã¯è¦‹é€ã‚‹ã®ãŒå®‰å…¨ã§ã™ã€‚")
    else:
        summary = ("è²·ã„ãƒ»å£²ã‚ŠãŒæ‹®æŠ—ã—ã¦ãŠã‚Šã€æ˜ç¢ºãªæ–¹å‘æ„Ÿã«æ¬ ã‘ã‚‹ç›¸å ´ã§ã™ã€‚"
                  "ãƒˆãƒ¬ãƒ³ãƒ‰ãŒæ˜ç¢ºã«ãªã‚‹ã¾ã§é™è¦³ã—ã€éå‰°ãªå–å¼•ã‚’é¿ã‘ã¾ã—ã‚‡ã†ã€‚")

    # HTMLå½¢å¼ã§è¦‹ã‚„ã™ãå‡ºåŠ›
    html = "<div style='font-size:14px; line-height:1.6em;'>"
    if buy_comments:
        html += "<b>ğŸŸ¢ è²·ã„ç›®ç·šã®è¦å› ï¼š</b><ul>" + "".join(buy_comments) + "</ul><br>"
    if sell_comments:
        html += "<b>ğŸ”´ å£²ã‚Šç›®ç·šã®è¦å› ï¼š</b><ul>" + "".join(sell_comments) + "</ul><br>"
    html += f"<b>âš–ï¸ ç·è©•ã¨æˆ¦ç•¥ï¼š</b><p>{summary}</p></div>"

    return html

# 3. ãƒãƒ£ãƒ¼ãƒˆï¼‹ãƒ†ãƒ¼ãƒ–ãƒ«ä¿å­˜é–¢æ•°
"""
è¡¨ï¼ˆHTMLï¼‰ã¨ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’çµåˆã—ã€JPGã¨å¿…è¦ã«å¿œã˜ã¦PDFã¨ã—ã¦ä¿å­˜ã€‚
"""
def save_combined_chart_and_table(chart_path, html_table, output_dir, symbol, name, today_str,
                                  table_image_path="table_temp.jpg", save_pdf=False):
    """
    HTMLãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’çµåˆã—ã€JPGï¼‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ï¼‰PDFã¨ã—ã¦ä¿å­˜ã™ã‚‹
    """

    # âœ… HTMLâ†’ç”»åƒåŒ–ï¼ˆStylerãªã—HTMLã‚’ä½¿ç”¨ï¼‰
    with open("temp_table.html", "w", encoding="utf-8") as f:
        f.write(html_table)

    # âœ… wkhtmltoimageã®ãƒ‘ã‚¹å–å¾—
    import shutil
    wkhtml_path = shutil.which("wkhtmltoimage") or "/usr/bin/wkhtmltoimage"
    if not os.path.exists(wkhtml_path):
        raise EnvironmentError("âŒ wkhtmltoimage ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Colabã¾ãŸã¯ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚")

    # âœ… imgkitã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆç”»åƒå‡ºåŠ›å½¢å¼ã¨å“è³ªï¼‰
    import imgkit
    config = imgkit.config(wkhtmltoimage=wkhtml_path)
    options = {
        'format': 'jpg',
        'encoding': "UTF-8",
        'custom-header': [('Accept-Encoding', 'gzip')],
        'quality': '85',
        'zoom': 2,
        'crop-w': 1600  # å¿…è¦ã«å¿œã˜ã¦æ¨ªå¹…ã‚’èª¿æ•´
    }
    imgkit.from_file("temp_table.html", table_image_path, config=config, options=options)

    # âœ… PILã§ç”»åƒèª­ã¿è¾¼ã¿ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«â†’ä¸Šã€ãƒãƒ£ãƒ¼ãƒˆâ†’ä¸‹ï¼‰
    from PIL import Image as PILImage
    chart_img = PILImage.open(chart_path)
    table_img = PILImage.open(table_image_path)

    # âœ… ãƒªã‚µã‚¤ã‚ºï¼ˆå¹…ã‚’çµ±ä¸€ï¼‰
    def resize_to_width(img, target_width):
        w, h = img.size
        if w == target_width:
            return img
        new_h = int(h * (target_width / w))
        return img.resize((target_width, new_h), PILImage.LANCZOS)

    max_width = max(chart_img.width, table_img.width)
    table_img = resize_to_width(table_img, max_width)
    chart_img = resize_to_width(chart_img, max_width)

    # âœ… ç”»åƒçµåˆ
    combined_height = table_img.height + chart_img.height
    combined_img = PILImage.new("RGB", (max_width, combined_height), "white")
    #combined_img.paste(table_img, (0, 0))
    #combined_img.paste(chart_img, (0, table_img.height))
    combined_img.paste(chart_img, (0, 0))                     # â† å…ˆã«ãƒãƒ£ãƒ¼ãƒˆ
    combined_img.paste(table_img, (0, chart_img.height))      # â† å¾Œã«ãƒ†ãƒ¼ãƒ–ãƒ«

    # âœ… ä¿å­˜ãƒ‘ã‚¹æº–å‚™
    save_folder = os.path.join(output_dir, f"{symbol}_{name}")
    os.makedirs(save_folder, exist_ok=True)
    base_filename = f"{symbol}_{name}_{today_str}"
    jpg_path = os.path.join(save_folder, base_filename + ".jpg")

    # âœ… JPGä¿å­˜
    combined_img.save(jpg_path, optimize=True, quality=85)
    print(f"âœ… JPGã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸï¼š{jpg_path}")

    # âœ… PDFä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if save_pdf:
        pdf_path = os.path.join(save_folder, base_filename + ".pdf")
        combined_img.convert("RGB").save(pdf_path, "PDF", resolution=100.0)
        print(f"ğŸ“„ PDFã¨ã—ã¦ã‚‚ä¿å­˜ã—ã¾ã—ãŸï¼š{pdf_path}")


######### 1.ãƒ«ãƒ¼ãƒ—-START

for symbol in symbols:
    try:
        info = yf.Ticker(symbol).info
        name = info.get("shortName", "åç§°ä¸æ˜")
        df = yf.download(symbol, period="15mo", interval="1d", auto_adjust=False)
        if isinstance(df.columns, pd.MultiIndex):
            df.columns = df.columns.get_level_values(0)
        df = df.dropna(subset=["Open", "High", "Low", "Close", "Volume"]).astype(float)
        df.index.name = "Date"
        # ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™
        df["RSI"] = momentum.RSIIndicator(df["Close"], window=14).rsi()
        df["Vol_MA5"] = df["Volume"].rolling(5).mean()
        df["Vol_MA25"] = df["Volume"].rolling(25).mean()
        df["MA5"] = df["Close"].rolling(5).mean()
        df["MA25"] = df["Close"].rolling(25).mean()
        df["MA75"] = df["Close"].rolling(75).mean()
        df["MA200"] = df["Close"].rolling(200).mean()
        if SHOW_MACD:
            macd = MACD(df["Close"])
            df["MACD"] = macd.macd()
            df["MACD_Signal"] = macd.macd_signal()
            df["MACD_Diff"] = macd.macd_diff()
        if SHOW_BB:
            bb = BollingerBands(df["Close"])
            df["BB_High"] = bb.bollinger_hband()
            df["BB_Low"] = bb.bollinger_lband()
            df["BB_MAVG"] = bb.bollinger_mavg()
        if SHOW_ADX:
            adx = ADXIndicator(df["High"], df["Low"], df["Close"])
            df["ADX"] = adx.adx()
        if SHOW_STOCH:
            stoch = StochasticOscillator(df["High"], df["Low"], df["Close"])
            df["STOCH_K"] = stoch.stoch()
            df["STOCH_D"] = stoch.stoch_signal()
        if SHOW_MA_DEVIATION:
            df["MA25_Deviation"] = (df["Close"] - df["MA25"]) / df["MA25"] * 100
        df_filtered = df.dropna().copy()
        df_recent = df_filtered[-60:]
        df_recent = df_recent.copy()
        if df_recent.empty:
            print(f"âš ï¸ {symbol} ã¯ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã§ã‚¹ã‚­ãƒƒãƒ—")
            continue

######### 2.ãƒãƒ£ãƒ¼ãƒˆ-START

        # åˆæœŸåŒ–
        add_plots = []
        panel_id = 2  # panel=0: Price, panel=1: Volumeï¼ˆè‡ªå‹•ï¼‰
        rsi_ax_index = None

        # ç©ºãƒ‘ãƒãƒ«ã‚’æ¤œå‡ºã—ã¦ panel_ratios ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹é–¢æ•°
        def get_used_panels(add_plots):
            used_panels = set()
            for plot in add_plots:
                if hasattr(plot, "get") and plot.get("panel") is not None:
                    used_panels.add(plot["panel"])
                elif isinstance(plot, dict) and "panel" in plot:
                    used_panels.add(plot["panel"])
            return sorted(used_panels)

        def generate_panel_ratios(used_panels, default_main=3, default_others=1):
            ratios = []
            for i in sorted(used_panels):
                if i == 0:
                    ratios.append(default_main)
                else:
                    ratios.append(default_others)
            return ratios

        # ãƒ”ãƒœãƒƒãƒˆãƒã‚¤ãƒ³ãƒˆï¼ˆæ ªä¾¡ã«ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ ï¼‰
        price = df_recent["Close"].values
        high_idx = argrelextrema(price, np.greater, order=5)[0]
        low_idx = argrelextrema(price, np.less, order=5)[0]
        high_marker = np.full(len(df_recent), np.nan)
        low_marker = np.full(len(df_recent), np.nan)
        high_marker[high_idx] = price[high_idx]
        low_marker[low_idx] = price[low_idx]
        add_plots += [
            mpf.make_addplot(high_marker, type='scatter', markersize=100, marker='^', color='red', panel=0),
            mpf.make_addplot(low_marker, type='scatter', markersize=100, marker='v', color='green', panel=0),
        ]

        # ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰ã®è¨­å®š
        #if SHOW_BB:
        #    add_plots += [
        #        mpf.make_addplot(df_recent["BB_MAVG"], panel=0, color="blue", linestyle='dotted', width=1, label="BB_MAVG"),
        #        mpf.make_addplot(df_recent["BB_High"], panel=0, color="gray", linestyle='dashed', width=1, label="BB_High"),
        #        mpf.make_addplot(df_recent["BB_Low"], panel=0, color="gray", linestyle='dashed', width=1, label="BB_Low")
        #    ]

        # RSI
        if SHOW_RSI:
            rsi_panel_id = panel_id
            add_plots.append(
                mpf.make_addplot(df_recent["RSI"], panel=rsi_panel_id, color="black", width=1.5, ylabel="RSI")
            )
            panel_id += 1

        # MACD
        if SHOW_MACD:
            macd_panel = panel_id
            buy_signal = (df_recent["MACD"].shift(1) < df_recent["MACD_Signal"].shift(1)) & (df_recent["MACD"] > df_recent["MACD_Signal"])
            sell_signal = (df_recent["MACD"].shift(1) > df_recent["MACD_Signal"].shift(1)) & (df_recent["MACD"] < df_recent["MACD_Signal"])
            vol_ma5 = df_recent["Volume"].rolling(5).mean()
            buy_filter = (df_recent["MACD"] > 0) & (df_recent["MACD_Diff"] > 0) & (df_recent["RSI"] < 70) & (df_recent["Volume"] > vol_ma5)
            sell_filter = (df_recent["MACD"] < 0) & (df_recent["MACD_Diff"] < 0) & (df_recent["RSI"] > 30) & (df_recent["Volume"] > vol_ma5)
            macd_cross_buy = df_recent["MACD"].where(buy_signal & buy_filter)
            macd_cross_sell = df_recent["MACD"].where(sell_signal & sell_filter)

            add_plots += [
                mpf.make_addplot(df_recent["MACD"], panel=macd_panel, color="green", width=1.2, ylabel="MACD"),
                mpf.make_addplot(df_recent["MACD_Signal"], panel=macd_panel, color="red", width=1.0),
                mpf.make_addplot(df_recent["MACD_Diff"], panel=macd_panel, type='bar', color="purple", alpha=0.6)
            ]
            if not macd_cross_buy.dropna().empty:
                add_plots.append(mpf.make_addplot(macd_cross_buy, panel=macd_panel, type='scatter', marker='o', markersize=80, color='green'))
            if not macd_cross_sell.dropna().empty:
                add_plots.append(mpf.make_addplot(macd_cross_sell, panel=macd_panel, type='scatter', marker='o', markersize=80, color='red'))

            panel_id += 1

        # ä½¿ç”¨ã•ã‚ŒãŸãƒ‘ãƒãƒ«ç•ªå·ã‹ã‚‰æ­£ã—ã„æ¯”ç‡ã‚’ç”Ÿæˆ
        used_panels = get_used_panels(add_plots)
        used_panels.append(1)  # å‡ºæ¥é«˜ç”¨ã® panel=1 ã‚’æ‰‹å‹•è¿½åŠ ï¼ˆvolume=True ã®ãŸã‚ï¼‰
        used_panels = sorted(set(used_panels))
        panel_ratios = generate_panel_ratios(used_panels, default_main=3, default_others=1)
        print(f"[DEBUG] panel_ratios = {panel_ratios} | used_panels = {used_panels}")

        # ãƒãƒ£ãƒ¼ãƒˆæç”»
        fig, axlist = mpf.plot(
            df_recent,
            type="candle",
            style="yahoo",
            volume=True,
            addplot=add_plots,
            scale_padding={'left': 0.25, 'right': 0.75},  # ä½™ç™½ã‚’æœ€å°é™ã«
            panel_ratios=panel_ratios,
            figsize=(14, 8),
            returnfig=True
        )
        # ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­—åˆ—ã‚’å®šç¾©
        title = f"{name}ï¼ˆ{symbol}ï¼‰æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆï¼ˆç›´è¿‘60æ—¥ï¼‰ - {today_str}"
        # æç”»å¾Œã® axlist[0] ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
        axlist[0].set_title(
            title,
            fontproperties=jp_font,
            fontsize=15,
            pad=20,
        )
        # ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆã®ä¸Šã«ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤ºï¼ˆå·¦å¯„ã›ã‚„ä¸­å¤®ã«ã§ãã‚‹ï¼‰
        subtitle = f"å¯¾è±¡æœŸé–“ï¼š{df.index[0].strftime('%Y/%m/%d')} ï½ {df.index[-1].strftime('%Y/%m/%d')}ï½œå‚¾å‘ï¼šä¸‹é™ãƒˆãƒ¬ãƒ³ãƒ‰ç¶™ç¶šä¸­"
        # axlist[0] ä¸Šéƒ¨ã«ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ ï¼ˆåº§æ¨™: x=0.5, y=1.08 ã¯ä¸Šéƒ¨ä¸­å¤®ï¼‰
        axlist[0].text(
            0.5, 1.07,  # X, Yï¼ˆ0ï½1ã®ç›¸å¯¾å€¤ï¼‰
            subtitle,
            transform=axlist[0].transAxes,  # è»¸ã«å¯¾ã—ã¦ç›¸å¯¾ä½ç½®
            ha='center',                    # æ°´å¹³ä¸­å¤®æƒãˆ
            va='top',                       # å‚ç›´ä¸Šæƒãˆ
            fontsize=12,
            fontproperties=jp_font,
            color='dimgray'
        )
        fig.subplots_adjust(left=0.05, right=0.95)
        fig.savefig("chart_output.png", dpi=150, bbox_inches="tight")

        # ã‚µãƒãƒ¼ãƒˆãƒ»ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ³ã‚¹ãƒ©ã‚¤ãƒ³
        price_ax = axlist[0]
        sr_windows = [20, 60]
        support_colors = ["#1f77b4", "#17becf"]
        resistance_colors = ["#d62728", "#ff7f0e"]
        x_pos = len(df_recent) + 1
        for idx, window in enumerate(sr_windows):
            if len(df_recent) >= window:
                support = df_recent["Low"].rolling(window).min().iloc[-1]
                resist = df_recent["High"].rolling(window).max().iloc[-1]
                price_ax.axhline(support, color=support_colors[idx % 2], linestyle='--', linewidth=1.2, alpha=0.8)
                price_ax.axhline(resist, color=resistance_colors[idx % 2], linestyle='--', linewidth=1.2, alpha=0.8)
                price_ax.text(x_pos, support, f"\u2190 Support ({window}d)", va='center', fontsize=8, color=support_colors[idx % 2])
                price_ax.text(x_pos, resist, f"\u2190 Resistance ({window}d)", va='center', fontsize=8, color=resistance_colors[idx % 2])

        # å‡¡ä¾‹è¡¨ç¤ºï¼ˆãƒ©ãƒ™ãƒ«ä»˜ãã®è¦ç´ ãŒã‚ã‚‹ã¨ãã®ã¿ï¼‰
        if any(line.get_label() and not line.get_label().startswith("_") for line in price_ax.lines):
            price_ax.legend(loc='upper left', fontsize='small')

        # RSIè¡¨ç¤ºè¨­å®š
        target_rsi_ax = next((ax for ax in axlist if ax.get_ylabel() == "RSI"), None)
        if target_rsi_ax:
            target_rsi_ax.set_ylim(0, 100)
            target_rsi_ax.set_yticks([20, 40, 60, 80])
            target_rsi_ax.axhline(80, color='red', linestyle='--', linewidth=1)
            target_rsi_ax.axhline(20, color='blue', linestyle='--', linewidth=1)

        # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ä¿å­˜
        try:
            fig.tight_layout()
        except Exception as e:
            print(f"[è­¦å‘Š] tight_layout ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        chart_path = f"{symbol}_{name}_{today_str}.png"
        if SHOW_SAVE_CHART:
            # âœ… tight_layout ã¯å¿…ãšä¿å­˜å‰ã«å‘¼ã¶
            fig.tight_layout()
            fig.savefig(chart_path, dpi=150)
            plt.close(fig)
        if not os.path.exists(chart_path):
            raise FileNotFoundError(f"ãƒãƒ£ãƒ¼ãƒˆç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {chart_path}")

######### 2.ãƒãƒ£ãƒ¼ãƒˆ-END

######### 3.ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæŒ‡æ¨™åˆ¤æ–­ï¼‰-START

        # ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒƒãƒ—ã«å®‰å…¨ã‹ã¤çµ±ä¸€çš„ã«ç™»éŒ²ã™ã‚‹é–¢æ•°

        def add_comment(comment_map, key, signal, detail, note=""):
            icon = {"è²·ã„": "ğŸŸ¢", "å£²ã‚Š": "ğŸ”´", "ä¸­ç«‹": "ğŸŸ¡"}.get(signal, "")
            full_note = f" {note}" if note else ""
            comment_map[key] = f"{signal}ï½œ{detail}{full_note}".strip()

        # ä¿¡é ¼åº¦ã®åˆ†é¡ã¨ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        def judge_strength(gap_value, thresholds):
            if gap_value > thresholds["å¼·"]:
                return "å¼·"
            elif gap_value > thresholds["ä¸­"]:
                return "ä¸­"
            else:
                return "å¼±"

        def format_note(strength, vol_increased):
            vol_note = "å‡ºæ¥é«˜å¢—" if vol_increased else ""
            return f"[ä¿¡é ¼åº¦{strength}/{vol_note}]" if vol_note else f"[ä¿¡é ¼åº¦{strength}]"

        # åˆ©ç”¨ä¾‹
        score = 0
        comment_map = {}

        # ========= 1. ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æ•´å½¢ =========
        # df_recent_week ã®å®šç¾©
        df_recent_week = df.tail(7)

        # ========= 2. æœ€æ–°ãƒ»å‰æ—¥ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º =========
        # æœ€æ–°ãƒ»å‰æ—¥ãƒ‡ãƒ¼ã‚¿ã®å®šç¾©
        latest = df.iloc[-1]
        previous = df.iloc[-2]

        # æ ªä¾¡çµ‚å€¤ãƒ»å‡ºæ¥é«˜
        diff = latest["Close"] - previous["Close"]
        add_comment(comment_map, "æ ªä¾¡ï¼ˆçµ‚å€¤ï¼‰", "ä¸­ç«‹", f"çµ‚å€¤={latest['Close']:.2f}ï¼ˆå‰æ—¥æ¯”{diff:+.2f}ï¼‰")

        vol_latest = latest["Volume"]
        vol_avg = df_recent_week["Volume"].mean()
        diff = vol_latest - vol_avg
        pct = round((diff / vol_avg) * 100, 1)
        add_comment(comment_map, "å‡ºæ¥é«˜", "ä¸­ç«‹", f"7æ—¥å¹³å‡={vol_avg:,.0f}ï¼ˆå·®åˆ†={diff:+,.0f} / {pct:+.1f}%ï¼‰")

        # ç§»å‹•å¹³å‡ã‚¯ãƒ­ã‚¹ã®ä¾‹ï¼ˆè¿½åŠ ï¼‰
        ma_pairs = [
            ("5DMA", "25DMA", latest["MA5"], latest["MA25"], previous["MA5"], previous["MA25"], "çŸ­æœŸ"),
            ("25DMA", "75DMA", latest["MA25"], latest["MA75"], previous["MA25"], previous["MA75"], "ä¸­æœŸ"),
            ("75DMA", "200DMA", latest["MA75"], latest["MA200"], previous["MA75"], previous["MA200"], "é•·æœŸ")
        ]
        for key, base_key, cur, base, cur_prev, base_prev, label in ma_pairs:
            gap = (cur - base) / base * 100
            diff = cur - base
            relation = f"{key} > {base_key}" if diff > 0 else f"{key} < {base_key}"
            diff_str = f"{relation}, å·®åˆ†={diff:+.2f}å††"
            crossed_up = cur > base and cur_prev <= base_prev
            crossed_down = cur < base and cur_prev >= base_prev
            if crossed_up:
                strength = judge_strength(gap, thresholds)
                strength = {"å¼±": "ä¸­", "ä¸­": "å¼·", "å¼·": "æœ€å¼·"}[strength] if vol_increased else strength
                note = format_note(strength, vol_increased)
                add_comment(comment_map, key, "è²·ã„", f"{label}GCï¼ˆ{diff_str}ï¼‰", note)
                score += {"å¼±": 1, "ä¸­": 2, "å¼·": 3, "æœ€å¼·": 4}[strength]
            elif crossed_down:
                gap = abs(gap)
                strength = judge_strength(gap, thresholds)
                strength = {"å¼±": "ä¸­", "ä¸­": "å¼·", "å¼·": "æœ€å¼·"}[strength] if vol_increased else strength
                note = format_note(strength, vol_increased)
                add_comment(comment_map, key, "å£²ã‚Š", f"{label}DCï¼ˆ{diff_str}ï¼‰", note)
                score -= {"å¼±": 1, "ä¸­": 2, "å¼·": 3, "æœ€å¼·": 4}[strength]
            else:
                add_comment(comment_map, key, "ä¸­ç«‹", f"æ˜ç¢ºãªã‚¯ãƒ­ã‚¹ãªã—ï¼ˆ{diff_str}ï¼‰")

        # è¶…GC / è¶…DC åˆ¤å®š
        ma5, ma25, ma75 = latest["MA5"], latest["MA25"], latest["MA75"]
        diff_super = ma5 - ma75
        diff_str_super = f"å·®åˆ†={diff_super:+.2f}å††"
        if ma5 > ma25 > ma75:
            add_comment(comment_map, "è¶…GC", "è²·ã„", f"è¶…GCï¼ˆ5DMA > 25DMA > 75DMA, {diff_str_super}ï¼‰", "[ä¿¡é ¼åº¦æœ€å¼·]")
            score += 4
        elif ma5 < ma25 < ma75:
            add_comment(comment_map, "è¶…DC", "å£²ã‚Š", f"è¶…DCï¼ˆ5DMA < 25DMA < 75DMA, {diff_str_super}ï¼‰", "[ä¿¡é ¼åº¦æœ€å¼·]")
            score -= 4
        else:
            if ma5 > ma25 and ma25 < ma75:
                trend_desc = "5DMA > 25DMA < 75DMA"
            elif ma5 < ma25 and ma25 > ma75:
                trend_desc = "5DMA < 25DMA > 75DMA"
            elif ma5 > ma75 and ma25 < ma75:
                trend_desc = "5DMA > 75DMA > 25DMA"
            else:
                trend_desc = "é †åºãƒãƒ©ãƒãƒ©"
            add_comment(comment_map, "è¶…GC/DC", "ä¸­ç«‹", f"æ˜ç¢ºãªã‚·ã‚°ãƒŠãƒ«ãªã—ï¼ˆ{trend_desc}, {diff_str_super}ï¼‰")

        # 25æ—¥ä¹–é›¢ç‡
        dev = latest["MA25_Deviation"]
        if dev > 5:
            add_comment(comment_map, "25æ—¥ä¹–é›¢ç‡ï¼ˆ%ï¼‰", "å£²ã‚Š", "å¹³å‡ã‚ˆã‚Šå¤§ããä¸ŠæŒ¯ã‚Œï¼ˆéç†±æ„Ÿã‚ã‚Šï¼‰")
        elif dev < -5:
            add_comment(comment_map, "25æ—¥ä¹–é›¢ç‡ï¼ˆ%ï¼‰", "è²·ã„", "å¹³å‡ã‚ˆã‚Šå¤§ããä¸‹æŒ¯ã‚Œï¼ˆå‰²å®‰æ„Ÿã‚ã‚Šï¼‰")
        else:
            add_comment(comment_map, "25æ—¥ä¹–é›¢ç‡ï¼ˆ%ï¼‰", "ä¸­ç«‹", "å¹³å‡ä»˜è¿‘ã§å®‰å®š")

        # ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰
        diff_from_mid = latest["Close"] - latest["BB_MAVG"]
        band_width = latest["BB_High"] - latest["BB_Low"]
        deviation = (latest["Close"] - latest["BB_Low"]) / band_width * 100
        if latest["Close"] > latest["BB_High"]:
            add_comment(comment_map, "BBä¸Šé™", "å£²ã‚Š", f"{latest['Close']:.2f}å††ï¼ˆçµ‚å€¤ï¼‰ > BBä¸Šé™={latest['BB_High']:.2f}å††ï½œãƒãƒ³ãƒ‰ã‚’ä¸ŠæŠœã‘ï¼ˆè²·ã‚ã‚Œã™ãï¼‰ğŸš¨")
        elif latest["Close"] < latest["BB_Low"]:
            add_comment(comment_map, "BBä¸‹é™", "è²·ã„", f"{latest['Close']:.2f}å††ï¼ˆçµ‚å€¤ï¼‰ < BBä¸‹é™={latest['BB_Low']:.2f}å††ï½œãƒãƒ³ãƒ‰ã‚’ä¸‹æŠœã‘ï¼ˆå£²ã‚‰ã‚Œã™ãï¼‰ğŸ“‰")
        else:
            zone = "ä¸Šå¯„ã‚Šï¼ˆã‚„ã‚„å‰²é«˜ï¼‰" if deviation > 66 else "ä¸‹å¯„ã‚Šï¼ˆã‚„ã‚„å‰²å®‰ï¼‰" if deviation < 33 else "ä¸­å¤®ä»˜è¿‘ï¼ˆå®‰å®šåœï¼‰"
            add_comment(comment_map, "BBä¸­å¤®", "ä¸­ç«‹", f"{latest['Close']:.2f}å††ï¼ˆçµ‚å€¤ï¼‰ã¯ãƒãƒ³ãƒ‰å†…ã®{zone}ï½œä¸­å¿ƒä¹–é›¢={diff_from_mid:+.2f}å††")

        # RSI
        val, prev_val = latest["RSI"], previous["RSI"]
        diff = val - prev_val
        trend = "ä¸Šæ˜‡ä¸­" if diff > 0 else "ä½ä¸‹ä¸­"
        if val > 80:
            strength = "å¼·" if val >= 82 else "ä¸­" if val >= 81 else "å¼±"
            add_comment(comment_map, "RSI", "å£²ã‚Š", f"è²·ã‚ã‚Œã™ãï¼ˆ{trend} / éç†±åº¦ï¼š{strength}ï¼‰")
        elif val < 20:
            strength = "å¼·" if val <= 18 else "ä¸­" if val <= 19 else "å¼±"
            add_comment(comment_map, "RSI", "è²·ã„", f"å£²ã‚‰ã‚Œã™ãï¼ˆ{trend} / å‰²å®‰åº¦ï¼š{strength}ï¼‰")
        else:
            add_comment(comment_map, "RSI", "ä¸­ç«‹", f"æ˜ç¢ºãªã‚·ã‚°ãƒŠãƒ«ãªã—ï¼ˆ{trend} / å‰æ—¥æ¯”{diff:+.2f}ï¼‰")

        # ã‚¹ãƒˆã‚­ãƒ£ã‚¹ï¼ˆ%Kï¼‰
        k, d = latest["STOCH_K"], latest["STOCH_D"]
        if k < 20 and k > d:
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ï¼ˆ%Kï¼‰", "è²·ã„", "å£²ã‚‰ã‚Œã™ãåœã‹ã‚‰åè»¢ã®å…†ã—")
        elif k > 80 and k < d:
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ï¼ˆ%Kï¼‰", "å£²ã‚Š", "è²·ã‚ã‚Œã™ãåœã‹ã‚‰åè½ã®å…†ã—")
        else:
            zone = "å£²ã‚‰ã‚Œã™ãåœ" if k < 20 else "è²·ã‚ã‚Œã™ãåœ" if k > 80 else "ä¸­ç«‹åœ"
            crossover = "ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹ï¼ˆä¸ŠæŠœã‘ï¼‰" if k > d else "ãƒ‡ãƒƒãƒ‰ã‚¯ãƒ­ã‚¹ï¼ˆä¸‹æŠœã‘ï¼‰" if k < d else "ä¸€è‡´"
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ï¼ˆ%Kï¼‰", "ä¸­ç«‹", f"%K={k:.2f}ï½œ{zone}ã§{k:.2f}ï¼ˆ{crossover}ï¼‰")

        # ã‚¹ãƒˆã‚­ãƒ£ã‚¹ï¼ˆ%Dï¼‰
        d_val, prev_d_val = latest["STOCH_D"], previous["STOCH_D"]
        if d_val > 80:
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ï¼ˆ%Dï¼‰", "å£²ã‚Š", "è²·ã‚ã‚Œã™ãåœã«æ»åœ¨")
        elif d_val < 20:
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ï¼ˆ%Dï¼‰", "è²·ã„", "å£²ã‚‰ã‚Œã™ãåœã«æ»åœ¨")
        else:
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ï¼ˆ%Dï¼‰", "ä¸­ç«‹", "æ˜ç¢ºãªã‚µã‚¤ãƒ³ãªã—")

        # ã‚¹ãƒˆã‚­ãƒ£ã‚¹ç·åˆ
        k, d = latest["STOCH_K"], latest["STOCH_D"]
        if k < 20 and k > d:
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ç·åˆ", "è²·ã„", "å£²ã‚‰ã‚Œã™ãåœã§GCç™ºç”Ÿ")
            score += 1
        elif k > 80 and k < d:
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ç·åˆ", "å£²ã‚Š", "è²·ã‚ã‚Œã™ãåœã§DCç™ºç”Ÿ")
            score -= 1
        elif k > d and k < 50:
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ç·åˆ", "ä¸­ç«‹", "ä¸­ç«‹ã€œè²·ã„å¯„ã‚Šï½œä¸‹ä½åœã§ä¸Šæ˜‡ä¸­")
        elif k < d and k > 50:
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ç·åˆ", "ä¸­ç«‹", "ä¸­ç«‹ã€œå£²ã‚Šå¯„ã‚Šï½œä¸Šä½åœã§ä¸‹è½ä¸­")
        else:
            add_comment(comment_map, "ã‚¹ãƒˆã‚­ãƒ£ã‚¹ç·åˆ", "ä¸­ç«‹", "æ˜ç¢ºãªã‚·ã‚°ãƒŠãƒ«ãªã—")

        # MACD
        val, prev_val = latest["MACD_Diff"], previous["MACD_Diff"]
        diff = val - prev_val
        if val > 0:
            if diff > 0:
                add_comment(comment_map, "MACD", "è²·ã„", "MACDä¸Šæ˜‡ä¸­ï¼ˆå‹¢ã„å¼·ï¼‰")
            else:
                add_comment(comment_map, "MACD", "è²·ã„", "MACDãƒ—ãƒ©ã‚¹åœã ãŒæ¸›é€Ÿä¸­ï¼ˆæ…é‡ã«ï¼‰")
        else:
            if diff < 0:
                add_comment(comment_map, "MACD", "å£²ã‚Š", "MACDä¸‹é™ä¸­ï¼ˆå‹¢ã„å¼·ï¼‰")
            else:
                add_comment(comment_map, "MACD", "å£²ã‚Š", "MACDãƒã‚¤ãƒŠã‚¹åœã ãŒæ¸›é€Ÿä¸­ï¼ˆæ§˜å­è¦‹ï¼‰")

        # ADX
        val = latest["ADX"]
        if val < 20:
            add_comment(comment_map, "ADX", "ä¸­ç«‹", "æ–¹å‘æ„Ÿãªã—ï¼ˆæ§˜å­è¦‹ï¼‰")
        elif val < 25:
            add_comment(comment_map, "ADX", "ä¸­ç«‹", "è»¢æ›ï½œãƒˆãƒ¬ãƒ³ãƒ‰ç™ºç”Ÿã®å…†ã—ï¼ˆæ³¨ç›®ï¼‰")
        elif val < 40:
            add_comment(comment_map, "ADX", "ä¸­ç«‹", "è¿½éšï½œãƒˆãƒ¬ãƒ³ãƒ‰ç™ºç”Ÿä¸­ï¼ˆæµã‚Œã«ä¹—ã‚‹å ´é¢ï¼‰")
        else:
            add_comment(comment_map, "ADX", "ä¸­ç«‹", "éç†±ï½œãƒˆãƒ¬ãƒ³ãƒ‰éç†±ï¼ˆåè»¢ã«æ³¨æ„ï¼‰")

        # ç·åˆè©•ä¾¡
        comment_map["âœ… ç·åˆè©•ä¾¡"] = f"ã‚¹ã‚³ã‚¢: {score:.1f}"

######### 3.ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæŒ‡æ¨™åˆ¤æ–­ï¼‰-END

######### 4.ãƒ†ãƒ¼ãƒ–ãƒ«-START

        # è¡¨ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
        df_recent_week = df_filtered[-7:]
        date_labels = [d.strftime("%-m/%-d") for d in df_recent_week.index]
        divider = lambda name: [f"â”€â”€ {name} â”€â”€"] + ["" for _ in df_recent_week.index]
        table_data = []
        table_data.append(["æ ªä¾¡ï¼ˆçµ‚å€¤ï¼‰"] + [f"{v:.2f}" for v in df_recent_week["Close"]])
        table_data.append(["å‡ºæ¥é«˜"] + [abbreviate_number(v) for v in df_recent_week["Volume"]])
        table_data.append(divider("ç§»å‹•å¹³å‡ç³»"))
        if SHOW_PRICE_MA:
            table_data.append(["5DMA"] + [f"{v:.2f}" for v in df_recent_week["MA5"]])
            table_data.append(["25DMA"] + [f"{v:.2f}" for v in df_recent_week["MA25"]])
            table_data.append(["75DMA"] + [f"{v:.2f}" for v in df_recent_week["MA75"]])
            table_data.append(["200DMA"] + [f"{v:.2f}" for v in df_recent_week["MA200"]])
        if SHOW_MA_DEVIATION:
            table_data.append(["25æ—¥ä¹–é›¢ç‡ï¼ˆ%ï¼‰"] + [f"{v:.2f}" for v in df_recent_week["MA25_Deviation"]])
        table_data.append(divider("ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ç³»"))
        if SHOW_RSI:
            table_data.append(["RSI"] + [f"{v:.2f}" for v in df_recent_week["RSI"]])
        if SHOW_STOCH:
            table_data.append(["ã‚¹ãƒˆã‚­ãƒ£ã‚¹ï¼ˆ%Kï¼‰"] + [f"{v:.2f}" for v in df_recent_week["STOCH_K"]])
            table_data.append(["ã‚¹ãƒˆã‚­ãƒ£ã‚¹ï¼ˆ%Dï¼‰"] + [f"{v:.2f}" for v in df_recent_week["STOCH_D"]])
        table_data.append(divider("ãƒˆãƒ¬ãƒ³ãƒ‰ç³»"))
        if SHOW_MACD:
            table_data.append(["MACD"] + [f"{v:.2f}" for v in df_recent_week["MACD"]])
        if SHOW_ADX:
            table_data.append(["ADX"] + [f"{v:.2f}" for v in df_recent_week["ADX"]])
        table_data.append(divider("ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ç³»"))
        if SHOW_BB:
            table_data.append(["BBä¸Šé™"] + [f"{v:.2f}" for v in df_recent_week["BB_High"]])
            table_data.append(["BBä¸­å¤®"] + [f"{v:.2f}" for v in df_recent_week["BB_MAVG"]])
            table_data.append(["BBä¸‹é™"] + [f"{v:.2f}" for v in df_recent_week["BB_Low"]])

        # DataFrameã«å¤‰æ›
        df_table = pd.DataFrame(table_data, columns=["æŒ‡æ¨™"] + date_labels)

        # ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä»˜ä¸
        def emphasize(val):
            if "è²·ã„" in val:
                return f"ğŸŸ¢ {val}"
            elif "å£²ã‚Š" in val:
                return f"ğŸ”´ {val}"
            elif "ä¸­ç«‹" in val:
                return f"ğŸŸ¡ {val}"
            return val

        # ã‚³ãƒ¡ãƒ³ãƒˆåˆ—ã‚’è¿½åŠ 
        comment_list = [emphasize(comment_map.get(row[0], "")) for row in table_data]
        df_table["ã‚³ãƒ¡ãƒ³ãƒˆ"] = comment_list

        # CSSï¼ˆã‚³ãƒ¡ãƒ³ãƒˆåˆ—ã‚’å·¦å¯„ã›ï¼‰
        style = """
        <style>
        table {
          border-collapse: collapse;
          width: auto;  /* ğŸ‘ˆ ã“ã‚Œã«å¤‰æ›´ï¼ */
        }
        th, td {
          padding: 4px;
          border: 1px solid gainsboro;
          text-align: center;
        }
        td:last-child {
          text-align: left !important;
        }
        </style>
        """

        # âœ… åˆæœŸåŒ–
        summary_text = "âš ï¸ ç·åˆè©•ä¾¡ï¼šè©•ä¾¡æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼ˆã‚¹ã‚³ã‚¢æœªç®—å‡ºï¼‰"
        score = 0.0

        # âœ… å®‰å…¨ã«ã‚¹ã‚³ã‚¢ã‚’æŠ½å‡º
        if "âœ… ç·åˆè©•ä¾¡" in comment_map:
            try:
                score = float(comment_map["âœ… ç·åˆè©•ä¾¡"].split("ã‚¹ã‚³ã‚¢:")[-1])
                summary_text = generate_summary_comment(score)
            except Exception as e:
                print(f"âš ï¸ è©•ä¾¡ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {e}")
        else:
            print(f"âš ï¸ {symbol} - 'âœ… ç·åˆè©•ä¾¡' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")

        # âœ… ç·åˆè©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‹•çš„ã«ç”Ÿæˆ
        def generate_summary_comment(score):
            if score >= 7:
                return f"âœ… ç·åˆè©•ä¾¡ï¼šè²·ã„å‚¾å‘ï¼ˆã‚¹ã‚³ã‚¢: {score:.1f}ï¼‰"
            elif score >= 4:
                return f"âš ï¸ ç·åˆè©•ä¾¡ï¼šã‚„ã‚„è²·ã„ï¼ˆã‚¹ã‚³ã‚¢: {score:.1f}ï¼‰"
            elif score >= 1:
                return f"ğŸ˜ ç·åˆè©•ä¾¡ï¼šä¸­ç«‹ï¼ˆã‚¹ã‚³ã‚¢: {score:.1f}ï¼‰"
            elif score >= -2:
                return f"âš ï¸ ç·åˆè©•ä¾¡ï¼šã‚„ã‚„å£²ã‚Šï¼ˆã‚¹ã‚³ã‚¢: {score:.1f}ï¼‰"
            else:
                return f"âŒ ç·åˆè©•ä¾¡ï¼šå£²ã‚Šå‚¾å‘ï¼ˆã‚¹ã‚³ã‚¢: {score:.1f}ï¼‰"

        # âœ… scoreã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸ summary_text ã‚’ä½¿ã†
        colspan = len(df_table.columns)
        summary_row = f'<tr><td colspan="{colspan}" style="text-align:center; font-weight:bold; background:#eef;">{summary_text}</td></tr>'

        # âœ… HTMLãƒ‘ãƒ¼ãƒ„ã«åæ˜ 
        summary_html = f"""
        <p style="text-align:center; font-weight:bold; background:#eef; padding: 6px;">
        {summary_text}
        </p>
        """
        summary_row = f'<tr><td colspan="{colspan}" style="text-align:center; font-weight:bold; background:#eef;">{summary_text}</td></tr>'

        # âœ… ãƒ†ãƒ¼ãƒ–ãƒ«æœ«å°¾ã«ã¯è©•ä¾¡è¡Œã‚’è¿½åŠ ã—ãªã„
        html_table_with_summary = df_table.to_html(index=False, escape=False)

        # âœ… è¡¨å…¨ä½“ã®HTMLæ§‹é€ 
        html_table = f"""
        <html>
        <head>
        <meta charset="utf-8">
        {style}  <!-- âœ… CSS -->
        </head>
        <body>
        <h4>{name}ï¼ˆ{symbol}ï¼‰ï½œå–å¾—æ—¥: {today_str}</h4>
        {html_table_with_summary}
        </body>
        </html>
        """
        # âœ… è¡¨ç¤ºé †ã‚’æŒ‡å®š
        display(Image(chart_path))          # â‘  ãƒãƒ£ãƒ¼ãƒˆ
        display(HTML(summary_html))         # â‘¡ ç·åˆè©•ä¾¡ã ã‘åˆ¥è¡¨ç¤ºï¼ˆä¸­é–“ã«ï¼ï¼‰
        display(HTML(html_table))           # â‘¢ ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“

        # ğŸ‘‰ é–¢æ•°ã«æ¸¡ã™ã¨ãã¯ã“ã‚Œï¼
        save_combined_chart_and_table(
            chart_path=chart_path,
            html_table=html_table,  # â† ã“ã“ã‚’ä¿®æ­£
            output_dir="/content/drive/MyDrive/ColabNotebooks/éŠ˜æŸ„åˆ†æ",
            symbol=symbol,
            name=name,
            today_str=today_str,
            save_pdf=False
        )

######### 4.ãƒ†ãƒ¼ãƒ–ãƒ«-END

    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {symbol} - {e}")

######### 1.ãƒ«ãƒ¼ãƒ—-END
